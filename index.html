<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Random Video Calls</title>
  <style>
    :root {
      --bg: #0f1115; --panel: #171a21; --accent: #00d4ff; --text: #e7e9ee;
      --muted: #9aa3b2; --danger: #ff4d67; --warn: #ffb020;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; background: radial-gradient(1200px 800px at 80% -20%, #0b0d12 10%, var(--bg) 60%);
      color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
      border-bottom: 1px solid #1f232b; background: #0c0e13ac; backdrop-filter: saturate(120%) blur(6px);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: 0.3px }
    header .brand-dot { color: var(--accent) }
    header .status { display: flex; gap: 10px; align-items: center; font-size: 13px; color: var(--muted) }
    header .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #111419; border: 1px solid #232733; color: var(--muted) }
    #app { max-width: 1100px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 1.4fr 1fr; gap: 24px }
    @media (max-width: 980px) { #app { grid-template-columns: 1fr } }
    .panel { background: var(--panel); border: 1px solid #232733; border-radius: 14px; overflow: hidden; box-shadow: 0 12px 24px rgba(0,0,0,0.25) }
    .panel header { background: transparent; border: none; padding: 14px 16px; position: static }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px }
    @media (max-width: 700px) { .videos { grid-template-columns: 1fr } }
    .video-wrap { position: relative; border-radius: 10px; overflow: hidden; background: #0b0d12; border: 1px solid #1f232b; aspect-ratio: 16/10 }
    video { width: 100%; height: 100%; object-fit: cover; background: #000 }
    .label { position: absolute; bottom: 8px; left: 8px; background: #0b0d12cc; color: var(--muted); font-size: 12px; padding: 6px 8px; border-radius: 6px; border: 1px solid #232733; backdrop-filter: blur(4px) }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; padding: 14px; border-top: 1px solid #232733; background: #12151b }
    button { appearance: none; border: 1px solid #2a2f3b; color: var(--text); background: #12151b; padding: 10px 14px; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all .18s ease; cursor: pointer }
    button:hover { border-color: #3a4152; transform: translateY(-1px) }
    .primary { background: linear-gradient(180deg,#00d4ff,#00a0ff); border: none; color: #07121a }
    .primary:hover { filter: brightness(1.05) }
    .danger { background: linear-gradient(180deg,#ff7a8d,#ff4d67); border: none; color: #16060a }
    .ghost { background: #151922; border-color: #2a2f3b }
    .row { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px }
    .hint { font-size: 12px; color: var(--muted) }
    .log { padding: 12px 16px; font-size: 13px; color: var(--muted); height: 140px; overflow: auto; border-top: 1px solid #232733 }
    .badge { padding: 6px 10px; border: 1px dashed #2a2f3b; border-radius: 999px; font-size: 12px; color: var(--muted) }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr } }
  </style>
</head>
<body>
  <header>
    <h1>Random Video <span class="brand-dot">●</span> Calls</h1>
    <div class="status">
      <span class="pill" id="connStatus">Estado: offline</span>
      <span class="pill" id="matchStatus">Match: —</span>
    </div>
  </header>

  <div id="app">
    <section class="panel" id="callPanel">
      <header>
        <div class="row">
          <strong>Videollamada</strong>
          <span class="badge" id="roomBadge">room: —</span>
        </div>
      </header>
      <div class="videos">
        <div class="video-wrap">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="label">Remote</div>
        </div>
        <div class="video-wrap">
          <video id="localVideo" autoplay playsinline muted></video>
          <div class="label">Tú</div>
        </div>
      </div>
      <div class="controls">
        <button class="primary" id="startBtn">Start</button>
        <button class="ghost" id="nextBtn" disabled>Next</button>
        <button class="ghost" id="muteBtn" disabled>Mute</button>
        <button class="ghost" id="cameraBtn" disabled>Camera off</button>
        <button class="danger" id="endBtn" disabled>End</button>
      </div>
      <div class="log" id="log"></div>
    </section>

    <section class="panel">
      <header>
        <div class="row">
          <strong>Configuración</strong>
          <span class="hint">Usa HTTPS/localhost. Incluye TURN para NAT estrictos.</span>
        </div>
      </header>
      <div style="padding: 14px">
        <div class="grid">
          <div class="badge">Calidad: 720p</div>
          <div class="badge">Signaling: Firebase RTDB</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase v8 compat (simple para navegador sin bundler) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ======= TU CONFIG =======
    const firebaseConfig = {
      apiKey: "AIzaSyBWqJI7OKZcEjN2CeTZxPi8pWzo8rBMIkI",
      authDomain: "nearmemarketplace-ce82b.firebaseapp.com",
      projectId: "nearmemarketplace-ce82b",
      storageBucket: "nearmemarketplace-ce82b.firebasestorage.app",
      messagingSenderId: "711845990024",
      appId: "1:711845990024:web:7948ad5e5606765514d93d",
      measurementId: "G-X75JHEDQJ0",
      // Necesario para Realtime Database:
      databaseURL: "https://nearmemarketplace-ce82b-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======= UI =======
    const logEl = document.getElementById('log');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const muteBtn = document.getElementById('muteBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const endBtn = document.getElementById('endBtn');
    const connStatus = document.getElementById('connStatus');
    const matchStatus = document.getElementById('matchStatus');
    const roomBadge = document.getElementById('roomBadge');

    const log = (msg) => {
      const ts = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${ts}] ${msg}<br>` + logEl.innerHTML;
    };
    const setConn = (txt) => connStatus.textContent = `Estado: ${txt}`;
    const setMatch = (txt) => matchStatus.textContent = `Match: ${txt}`;
    const setRoom = (id) => roomBadge.textContent = `room: ${id || '—'}`;

    // ======= STATE =======
    let userId = `u_${Math.random().toString(36).slice(2,10)}`;
    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let currentRoomId = null;
    let role = null; // 'caller' | 'callee'
    let listeners = [];
    let inviteListener = null;

    // STUN (añade TURN propio para producción)
    const iceServers = [{ urls: ["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] }];

    // Media constraints
    const mediaConstraints = { audio: true, video: { width: { ideal: 1280 }, height: { ideal: 720 } } };

    // Refs
    const queueRef = db.ref('/queue');
    const roomsRef = db.ref('/rooms');
    const invitesRef = db.ref('/invites');

    function cleanupListeners() {
      listeners.forEach(unsub => { try { unsub(); } catch(e){} });
      listeners = [];
      if (inviteListener) { invitesRef.child(userId).off('value', inviteListener); inviteListener = null; }
    }

    async function initMedia() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        localVideo.srcObject = localStream;
        setConn('cam/mic ok');
        muteBtn.disabled = false;
        cameraBtn.disabled = false;
        return localStream;
      } catch(e) {
        log('Permisos de cámara/mic rechazados o fallo: ' + e.message);
        throw e;
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers });
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (ev) => {
        ev.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      };

      pc.onicecandidate = (ev) => {
        if (ev.candidate && currentRoomId && role) {
          const path = `/rooms/${currentRoomId}/candidates/${role}`;
          db.ref(path).push(ev.candidate.toJSON());
        }
      };

      pc.onconnectionstatechange = () => {
        setConn(pc.connectionState);
        if (pc.connectionState === 'connected') {
          setMatch('conectado');
        } else if (['disconnected','failed','closed'].includes(pc.connectionState)) {
          setMatch(pc.connectionState);
        }
      };

      return pc;
    }

    // Escuchar ICE remotos
    function listenRemoteCandidates(oppositeRole) {
      const ref = db.ref(`/rooms/${currentRoomId}/candidates/${oppositeRole}`);
      const handler = async snap => {
        const cand = snap.val();
        try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch(e) { console.warn('addIceCandidate error', e); }
      };
      ref.on('child_added', handler);
      listeners.push(() => ref.off('child_added', handler));
    }

    // ======= MATCHING =======
    async function findMatch() {
      // Primero intentamos tomar a alguien de la cola
      const snap = await queueRef.orderByChild('ts').limitToFirst(1).once('value');
      const val = snap.val();
      const entries = val ? Object.entries(val) : [];

      if (entries.length === 0) {
        // Entrar a cola y esperar invite
        const myNode = queueRef.push({ uid: userId, ts: Date.now() });
        setMatch('esperando');
        log('No hay usuarios disponibles. Entraste a la cola.');

        // Limpieza si cierro
        myNode.onDisconnect().remove();

        // Escuchar invitaciones dirigidas a mí
        inviteListener = invitesRef.child(userId).on('value', async (s) => {
          const invite = s.val();
          if (invite && invite.roomId) {
            await myNode.remove().catch(()=>{});
            await invitesRef.child(userId).remove().catch(()=>{});
            currentRoomId = invite.roomId;
            role = 'callee';
            setRoom(currentRoomId);
            log(`Recibiste invite a room ${currentRoomId}.`);
            await startCalleeFlow(currentRoomId);
          }
        });
        return;
      }

      // Emparejar con el primero en cola
      const [key, data] = entries[0];
      if (!data || data.uid === userId) {
        // Si el único soy yo, volver a esperar
        await queueRef.push({ uid: userId, ts: Date.now() });
        setMatch('esperando');
        log('Esperando otro usuario...');
        return;
      }
      await queueRef.child(key).remove().catch(()=>{});

      // Crear room e invitar
      currentRoomId = `r_${Math.random().toString(36).slice(2,10)}`;
      role = 'caller';
      setRoom(currentRoomId);
      await invitesRef.child(data.uid).set({ roomId: currentRoomId, from: userId, ts: Date.now() });
      log(`Creaste room ${currentRoomId} y enviaste invite a ${data.uid}.`);

      await startCallerFlow(currentRoomId);
    }

    // ======= CALLER FLOW =======
    async function startCallerFlow(roomId) {
      await initMedia();
      createPeerConnection();
      listenRemoteCandidates('callee');

      const offer = await pc.createOffer({ offerToReceiveAudio: 1, offerToReceiveVideo: 1 });
      await pc.setLocalDescription(offer);

      await roomsRef.child(roomId).child('offer').set({
        sdp: offer.sdp, type: offer.type, ts: Date.now(), by: userId
      });

      setConn('oferta enviada');
      log('Oferta enviada. Esperando respuesta...');

      const answerRef = roomsRef.child(roomId).child('answer');
      const handler = async snap => {
        const ans = snap.val();
        if (ans && ans.sdp && pc && !pc.remoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(ans));
          setConn('conectando...');
          log('Respuesta recibida. Estableciendo conexión...');
        }
      };
      answerRef.on('value', handler);
      listeners.push(() => answerRef.off('value', handler));

      enableControlsInCall();
    }

    // ======= CALLEE FLOW =======
    async function startCalleeFlow(roomId) {
      await initMedia();
      createPeerConnection();
      listenRemoteCandidates('caller');

      const offerSnap = await roomsRef.child(roomId).child('offer').once('value');
      const offer = offerSnap.val();
      if (!offer || !offer.sdp) {
        log('Error: oferta no encontrada.');
        return endCall(true);
      }
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await roomsRef.child(roomId).child('answer').set({
        sdp: answer.sdp, type: answer.type, ts: Date.now(), by: userId
      });

      setConn('respuesta enviada');
      log('Respuesta enviada. Conectando...');
      enableControlsInCall();
    }

    // ======= CONTROLES =======
    function enableControlsInCall() {
      startBtn.disabled = true;
      nextBtn.disabled = false;
      endBtn.disabled = false;
      muteBtn.disabled = false;
      cameraBtn.disabled = false;
    }
    function resetControls() {
      startBtn.disabled = false;
      nextBtn.disabled = true;
      endBtn.disabled = true;
      muteBtn.disabled = true;
      cameraBtn.disabled = true;
    }

    async function start() {
      try {
        await initMedia();
        await findMatch();
      } catch (e) {
        console.error(e);
        log('Error al iniciar: ' + e.message);
      }
    }

    async function next() {
      log('Siguiente: terminando y buscando nuevo match.');
      await endCall(false);
      await findMatch();
    }

    function toggleMute() {
      const enabled = localStream.getAudioTracks().some(t => t.enabled);
      localStream.getAudioTracks().forEach(t => t.enabled = !enabled);
      muteBtn.textContent = enabled ? 'Unmute' : 'Mute';
    }

    function toggleCamera() {
      const enabled = localStream.getVideoTracks().some(t => t.enabled);
      localStream.getVideoTracks().forEach(t => t.enabled = !enabled);
      cameraBtn.textContent = enabled ? 'Camera on' : 'Camera off';
    }

    async function endCall(clearRoom = true) {
      cleanupListeners();

      try {
        if (pc) {
          pc.ontrack = null;
          pc.onicecandidate = null;
          pc.onconnectionstatechange = null;
          pc.getSenders().forEach(s => { try { pc.removeTrack(s); } catch(e){} });
          pc.close();
        }
      } catch(e) {}
      pc = null;

      // Reinicia solo el remoto; deja local para rematch rápido
      if (remoteVideo.srcObject) { remoteVideo.srcObject.getTracks().forEach(t => t.stop()); }
      remoteVideo.srcObject = null;

      // Limpia signaling
      if (currentRoomId && clearRoom) {
        try { await roomsRef.child(currentRoomId).remove(); } catch(e) {}
      }
      currentRoomId = null;
      role = null;
      setRoom(null);
      setMatch('—');
      setConn('offline');
      resetControls();
    }

    // Wire UI
    startBtn.addEventListener('click', start);
    nextBtn.addEventListener('click', next);
    endBtn.addEventListener('click', () => endCall(true));
    muteBtn.addEventListener('click', toggleMute);
    cameraBtn.addEventListener('click', toggleCamera);

    // Estado inicial
    setConn('offline');
    setMatch('—');
    log('Listo. Pulsa Start en dos pestañas para probar el match.');
  </script>
</body>
</html>
